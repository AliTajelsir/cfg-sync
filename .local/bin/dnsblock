#!/usr/bin/env zsh
# Domains blocklist generator
local git_dir git_url utils_dir
	git_dir=$HOME/Git/dnscrypt-proxy
	git_url=https://github.com/DNSCrypt/dnscrypt-proxy.git
	utils_dir=utils_dirs/generate-domains-blocklist

if [[ ! -r $git_dir/$utils_dir/generate-domains-blocklist.py ]]; then
	git clone --no-checkout --depth 1 --filter=tree:0 $git_url $git_dir
	git -C $git_dir sparse-checkout set --no-cone $utils_dir
	git -C $git_dir checkout
fi

local config_dir=$XDG_CONFIG_HOME/dnscrypt-proxy
[[ -r $config_dir/domains-allowlist.txt ]] ||
	sed '/^t/i t.co' $git_dir/$utils_dir/domains-allowlist.txt > \
	$config_dir/domains-allowlist.txt

local -a block_opts=(
	--config $config_dir/domains-blocklist.conf
	--allowlist $config_dir/domains-blocklist.conf
	--time-restricted $git_dir/$utils_dir/domains-time-restricted.txt
	--output-file /sdcard/dnscrypt-proxy/blocked-names.txt
)

python $git_dir/$utils_dir/generate-domains-blocklist.py $block_opts

exit
